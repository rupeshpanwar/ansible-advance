---
- name: Simple Web Application
  hosts: db_and_webserver1,db_and_webserver2
  tasks:
  # python_version is a given variable, eg. `3.5`
   - name: Check if python is already latest
     command: python3 --version
     register: python_version_result
     failed_when: "{{ python_version_result.stdout | replace('Python ', '') | version_compare(python_version, '>=') }}"
   - name: Install prerequisites
     apt: name=python-software-properties state=present
     become: true

  #  - name: Install all required dependencies
  #    apt: 
  #     name: "{{ item }}"
  #     state: present
  #    with_items:
  #      - python-setuptools 
  #      - python-dev 
  #      - build-essential 
  #      - python-pip 
  #      - python-mysqldb
   - name: Install and Configure Database
     become: true
     apt: 
      name: "{{ item }}" 
      state: present
     with_items:
      - mysql-server 
      - mysql-client
  
   - name: Start MySQL Server Service
     service: 
      name: mysql
      state: started
      enabled: yes
   - name: Create database 
     mysql_db: 
      name: employee_db 
      state: present
   - name: Create database users
     mysql_user:
      name: db_user
      password: Passw0rd
      priv: '*.*:ALL'
      state: present
      host: '%'
   - name: Install Python Flask dependency
     pip:
      name: "{{ item }}"
      state: present
     with_items:
      - flask
      - flask-mysql
   - name: Copy source code
     copy:
      src: app.py
      dest: /opt/app.py
   - name: Start Web Server
     shell: FLASK_APP=/opt/app.py nohup flask run --host=0.0.0.0 &


